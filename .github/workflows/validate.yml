name: Code Quality Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Allow manual triggering
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Install development dependencies
        run: |
          pip install -r requirements-dev.txt
          
      - name: Run unit tests with coverage
        run: |
          echo "ðŸ§ª Running unit tests with coverage..."
          python -m pytest tests/ -v --tb=short --cov=src --cov-branch --cov-report=xml --cov-report=term-missing
          echo "âœ… Unit tests completed"
      
      - name: Upload coverage reports to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          verbose: true
      
      - name: Check Python syntax and compilation
        run: |
          echo "ðŸ Checking Python syntax and compilation..."
          python -m py_compile sync.py
          find src -name "*.py" -exec python -m py_compile {} \;
          find tests -name "*.py" -exec python -m py_compile {} \;
          echo "âœ… All Python files compile successfully"
      
      - name: Check code formatting with Black
        run: |
          echo "ðŸ–¤ Checking code formatting with Black..."
          black --check --diff --color .
          echo "âœ… Code formatting is correct"
      
      - name: Check import sorting with isort
        run: |
          echo "ðŸ“¦ Checking import sorting with isort..."
          isort --check-only --diff --color .
          echo "âœ… Import sorting is correct"
      
      - name: Lint with flake8
        run: |
          echo "ðŸ” Running flake8 linting..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics
          echo "âœ… Linting passed"
      
      - name: Type checking with mypy
        run: |
          echo "ðŸ” Running mypy type checking..."
          mypy sync.py src/ --ignore-missing-imports --no-strict-optional
          echo "âœ… Type checking passed"
      
      - name: Validate and format JSON files
        run: |
          echo "ðŸ“„ Validating JSON files..."
          
          # Function to validate JSON syntax
          validate_json() {
            if python -m json.tool "$1" > /dev/null 2>&1; then
              echo "âœ… $1 - Valid JSON syntax"
            else
              echo "âŒ $1 - Invalid JSON syntax"
              python -m json.tool "$1"
              exit 1
            fi
          }
          
          # Check if sync_state.json exists and validate it
          if [ -f "sync_state.json" ]; then
            validate_json "sync_state.json"
            
            # Verify the JSON structure has required fields
            python -c "
          import json
          with open('sync_state.json', 'r') as f:
              data = json.load(f)
          
          # Validate required top-level fields
          required_fields = ['last_sync_time', 'synced_posts', 'last_bluesky_post_uri']
          for field in required_fields:
              if field not in data:
                  raise ValueError(f'Missing required field: {field}')
          
          # Validate synced_posts structure
          if not isinstance(data['synced_posts'], list):
              raise ValueError('synced_posts must be a list')
          
          for i, post in enumerate(data['synced_posts']):
              required_post_fields = ['bluesky_uri', 'mastodon_id', 'synced_at']
              for field in required_post_fields:
                  if field not in post:
                      raise ValueError(f'Post {i} missing required field: {field}')
          
          print(f'âœ… sync_state.json structure validation passed ({len(data[\"synced_posts\"])} posts)')
            "
          else
            echo "â„¹ï¸ sync_state.json not found - will be created after first sync"
          fi
          
          # Validate other JSON files if they exist
          for json_file in *.json **/*.json; do
            if [ -f "$json_file" ] && [ "$json_file" != "sync_state.json" ]; then
              validate_json "$json_file"
            fi
          done
          
          echo "âœ… JSON validation completed"

      - name: Run basic imports test
        run: |
          echo "ðŸ§ª Testing basic imports..."
          python -c "
          import sys
          sys.path.insert(0, 'src')
          
          # Test core imports
          from src.config import get_settings
          from src.bluesky_client import BlueskyClient
          from src.mastodon_client import MastodonClient
          from src.sync_orchestrator import SocialSyncOrchestrator
          from src.sync_state import SyncState
          from src.content_processor import ContentProcessor
          
          print('âœ… All core modules import successfully')
          
          # Test CLI import
          import click
          print('âœ… CLI dependencies available')
          
          # Test API libraries
          import atproto
          import mastodon
          print('âœ… API libraries available')
          "
      
      - name: Test configuration loading
        run: |
          echo "âš™ï¸ Testing configuration loading..."
          python -c "
          import os
          os.environ['BLUESKY_HANDLE'] = 'test.bsky.social'
          os.environ['BLUESKY_PASSWORD'] = 'test-password'
          os.environ['MASTODON_API_BASE_URL'] = 'https://mastodon.social'
          os.environ['MASTODON_ACCESS_TOKEN'] = 'test-token'
          
          from src.config import get_settings
          settings = get_settings()
          
          assert settings.bluesky_handle == 'test.bsky.social'
          assert settings.mastodon_api_base_url == 'https://mastodon.social'
          print('âœ… Configuration loading works correctly')
          "
      
      - name: Test CLI help commands
        run: |
          echo "ðŸ–¥ï¸ Testing CLI help commands..."
          python sync.py --help
          python sync.py sync --help
          python sync.py status --help
          python sync.py config --help
          echo "âœ… CLI help commands work"
      
      - name: Validate project structure
        run: |
          echo "ðŸ“ Validating project structure..."
          
          # Check required files exist
          test -f sync.py && echo "âœ… sync.py exists"
          test -f requirements.txt && echo "âœ… requirements.txt exists"
          test -f README.md && echo "âœ… README.md exists"
          test -f .env.example && echo "âœ… .env.example exists"
          
          # Check directory structure
          test -d src && echo "âœ… src/ directory exists"
          test -d .github/workflows && echo "âœ… .github/workflows/ directory exists"
          test -d docs && echo "âœ… docs/ directory exists"
          test -d examples && echo "âœ… examples/ directory exists"
          
          # Check core modules
          test -f src/__init__.py && echo "âœ… src/__init__.py exists"
          test -f src/config.py && echo "âœ… src/config.py exists"
          test -f src/bluesky_client.py && echo "âœ… src/bluesky_client.py exists"
          test -f src/mastodon_client.py && echo "âœ… src/mastodon_client.py exists"
          test -f src/sync_orchestrator.py && echo "âœ… src/sync_orchestrator.py exists"
          test -f src/sync_state.py && echo "âœ… src/sync_state.py exists"
          test -f src/content_processor.py && echo "âœ… src/content_processor.py exists"
          
          echo "âœ… Project structure is valid"

      - name: Run integration tests
        env:
          BLUESKY_HANDLE: test.bsky.social
          BLUESKY_PASSWORD: test-password
          MASTODON_ACCESS_TOKEN: test-token-12345
          MASTODON_API_BASE_URL: https://mastodon.social
        run: |
          echo "ðŸ”— Running integration tests..."
          python tests/test_integration.py
          echo "âœ… Integration tests completed"
          
      - name: Run threading tests
        env:
          BLUESKY_HANDLE: test.bsky.social
          BLUESKY_PASSWORD: test-password
          MASTODON_ACCESS_TOKEN: test-token-12345
          MASTODON_API_BASE_URL: https://mastodon.social
        run: |
          echo "ðŸ§µ Running threading tests..."
          python tests/test_threading.py
          echo "âœ… Threading tests completed"
      
      - name: Validate sync dry-run
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
          MASTODON_ACCESS_TOKEN: ${{ secrets.MASTODON_ACCESS_TOKEN }}
          MASTODON_API_BASE_URL: ${{ secrets.MASTODON_API_BASE_URL }}
        run: |
          echo "ðŸ”„ Testing sync command with dry-run mode..."
          python sync.py --log-level=DEBUG sync --dry-run
          echo "âœ… Sync dry-run completed successfully"

  security-scan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run security scan with bandit
        run: |
          pip install bandit[toml]
          echo "ðŸ”’ Running security scan with bandit..."
          bandit -r src/ sync.py -f json -o bandit-report.json || true
          bandit -r src/ sync.py
          echo "âœ… Security scan completed"
      
      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results-${{ github.run_id }}
          path: bandit-report.json
          retention-days: 30

  dependency-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          # Install safety with compatible typer version to avoid compatibility issues
          pip install "safety>=3.0.0" "typer<0.8.0" pip-audit
      
      - name: Check for security vulnerabilities in dependencies
        run: |
          echo "ðŸ” Checking dependencies for security vulnerabilities..."
          
          echo "Running safety check..."
          # Use safety check with error handling for compatibility issues
          if safety check --json --output safety-report.json; then
            echo "âœ… Safety check passed"
          else
            echo "âš ï¸ Safety check had issues, but continuing..."
            echo "This might be due to safety/typer compatibility issues"
          fi
          
          # Try basic safety check without JSON output as fallback
          safety check --short-report || echo "âš ï¸ Safety check failed, but this is non-blocking"
          
          echo "Running pip-audit..."
          if pip-audit --format=json --output=pip-audit-report.json; then
            echo "âœ… pip-audit passed"
          else
            echo "âš ï¸ pip-audit had issues, but continuing..."
          fi
          
          # Try basic pip-audit as fallback
          pip-audit || echo "âš ï¸ pip-audit failed, but this is non-blocking"
          
          echo "âœ… Dependency security check completed (with fallbacks)"
      
      - name: Upload dependency scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results-${{ github.run_id }}
          path: |
            safety-report.json
            pip-audit-report.json
          retention-days: 30
